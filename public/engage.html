<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keilani Engage</title>

  <!-- Favicons / PWA -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#000000">

  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="app">
    <div class="header">
      <img src="/favicon-32x32.png" alt="Keilani" />
      <h1>Keilani Engage</h1>
    </div>

    <div class="card" id="status"><strong>Status:</strong> idle</div>

    <div id="ui" class="card" style="margin-top:12px;">
      <div style="margin-bottom:10px;"><strong>Avatar Stream</strong></div>

      <!-- Audio unlock button (autoplay policy) -->
      <button id="enable-audio" style="margin-bottom:10px; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#111; color:#fff; cursor:pointer;">
        ▶️ Start audio
      </button>

      <!-- Test form: send text → /api/chat → speak(reply) -->
      <form id="ask" style="margin-top:12px; display:flex; gap:8px;">
        <input id="prompt" type="text" placeholder="Type something for Keilani…" style="flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#0b0b0b; color:#fff;">
        <button type="submit" style="padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:#111; color:#fff; cursor:pointer;">Send</button>
      </form>
      <div class="small" style="margin-top:8px;">Tip: first click may be required for audio playback (browser policy).</div>
    </div>
  </div>

  <!-- Our bridge logic -->
  <script src="/brain-bridge.js"></script>

  <!-- D‑ID Agents SDK (recommended path) -->
  <script type="module">
    import * as sdk from "https://cdn.jsdelivr.net/npm/@d-id/client-sdk/+esm";

    // Your Agent + Client Key (safe for frontend; restrict domains in D‑ID Studio)
    const agentId   = "v2_agt_shuxsy-b";
    const clientKey = "Z29vZ2xlLW9hdXRoMnwxMDk2NTE3NDAzNTg3NDIxNzA0Mzk6ZDdiZEFBMThxN05DWVRPQzBZUkdV";

    // Create video for the WebRTC stream
    const videoEl = document.createElement("video");
    videoEl.setAttribute("playsinline", "");
    videoEl.autoplay = true;
    videoEl.muted = true; // start muted; we’ll unmute after user gesture
    videoEl.style.width = "480px";
    videoEl.style.maxWidth = "100%";
    document.getElementById("ui").prepend(videoEl);

    const setStatus = (txt) => {
      const s = document.getElementById("status");
      if (s) s.innerHTML = "<strong>Status:</strong> " + txt;
    };

    const callbacks = {
      onSrcObjectReady: (src) => { videoEl.srcObject = src; return src; },
      onConnectionStateChange: (state) => { setStatus(state); console.log("[D‑ID] state:", state); },
      onError: (err, data) => { console.error("[D‑ID] error:", err, data); setStatus("error – see console"); }
    };

    const auth = { type: "key", clientKey };
    const streamOptions = { compatibilityMode: "auto", streamWarmup: true };

    const agentManager = await sdk.createAgentManager(agentId, { auth, callbacks, streamOptions });
    await agentManager.connect();

    // Adapt to bridge "session" API
    const session = {
      speak: ({ text }) => agentManager.speak({ type: "text", input: text }),
      stopSpeaking: () => Promise.resolve() // swap to agentManager.disconnect() for hard stop if desired
    };

    // Initialize our bridge (status UI)
    initBrainBridge(session, { onStatus: setStatus });

    // Audio unlocks
    document.addEventListener("click", () => {
      if (videoEl.paused) videoEl.play().catch(() => {});
    }, { once: true });

    const btn = document.getElementById("enable-audio");
    if (btn) {
      btn.addEventListener("click", async () => {
        try {
          videoEl.muted = false;
          await videoEl.play();
          btn.textContent = "✅ Audio enabled";
          btn.disabled = true;
        } catch (e) {
          console.error("Audio unlock failed:", e);
          btn.textContent = "Retry start audio";
        }
      });
    }

    // Simple test loop: text → /api/chat → speak(reply)
    document.getElementById("ask").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("prompt");
      const text = (input.value || "").trim();
      if (!text) return;

      setStatus("thinking…");
      try {
        const resp = await fetch("/api/chat?threshold=0.6&count=8", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "00000000-0000-0000-0000-000000000001", message: text })
        });
        const data = await resp.json().catch(() => ({}));
        const reply = (data.reply || "Got it.").trim();
        await session.speak({ text: reply });
        setStatus("idle");
      } catch (err) {
        console.error(err);
        setStatus("error – chat failed");
      } finally {
        input.value = "";
      }
    });
  </script>

  <!-- IMPORTANT: Do NOT also include the floating embedded widget (agent.d-id.com/v2/index.js). -->
</body>
</html>
