<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keilani Chat Stream Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 2rem auto;
        max-width: 820px;
        font:
          16px/1.5 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          sans-serif;
        color: #eaeaea;
        background: #0b0b0c;
      }
      h1 {
        font-weight: 700;
        font-size: 1.35rem;
        margin: 0 0 1rem;
      }
      .card {
        background: #121214;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 1rem;
      }
      label {
        display: block;
        font-size: 0.95rem;
        color: #b6b6b6;
        margin-top: 0.5rem;
      }
      input,
      textarea {
        width: 100%;
        border: 1px solid #2a2a2a;
        background: #151518;
        color: #fff;
        border-radius: 10px;
        padding: 0.75rem;
        font: inherit;
      }
      textarea {
        min-height: 150px;
      }
      button {
        background: #6b7bff;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.7rem 1rem;
        font: 600 15px system-ui;
        cursor: pointer;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      .row > * {
        flex: 1;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .out {
        background: #0e0f12;
        border: 1px solid #222;
        border-radius: 10px;
        padding: 1rem;
        min-height: 140px;
      }
      .small {
        color: #9aa0a6;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <h1>Keilani Chat Streaming (SSE) Demo</h1>

    <div class="card">
      <div class="row">
        <label>
          Message
          <input id="msg" value="Tell me about synthwave." />
        </label>
        <label>
          User ID
          <input id="uid" value="123e4567-e89b-12d3-a456-426614174000" />
        </label>
      </div>

      <div style="display: flex; gap: 0.5rem; margin: 0.75rem 0 1rem">
        <button id="send">Stream</button>
        <button id="stop" disabled>Stop</button>
        <div id="status" class="small" style="margin-left: auto">idle</div>
      </div>

      <div class="out mono" id="out"></div>
    </div>

    <p class="small" style="margin-top: 1rem">
      This page uses <code>/api/chat-stream</code> with Server-Sent Events. It
      parses OpenAI-style streaming deltas and prints the content tokens as they
      arrive.
    </p>

    <script type="module">
      import { streamChat } from "/js/keilaniStream.v21.js";

      const $ = (sel) => document.querySelector(sel);
      const msg = $("#msg");
      const uid = $("#uid");
      const out = $("#out");
      const send = $("#send");
      const stop = $("#stop");
      const status = $("#status");

      let ctrl;

      function setState(running) {
        send.disabled = running;
        stop.disabled = !running;
        status.textContent = running ? "streamingâ€¦" : "idle";
      }

      send.addEventListener("click", async () => {
        setState(true);
        out.textContent = "";
        ctrl = new AbortController();

        try {
          await streamChat({
            message: msg.value,
            userId: uid.value,
            onToken: (t) => {
              out.textContent += t;
            },
            signal: ctrl.signal,
          });
        } catch (err) {
          out.textContent += `\n\n[error] ${err?.message || err}`;
          console.error(err);
        } finally {
          setState(false);
        }
      });

      stop.addEventListener("click", () => {
        if (ctrl) ctrl.abort();
        setState(false);
        out.textContent += "\n\n[stopped]";
      });
    </script>
  </body>
</html>
