<!doctype html>
<meta charset="utf-8" />
<title>SSE Probe</title>
<style>
  html,
  body {
    background: #0b0b0b;
    color: #d8d8d8;
    font:
      14px ui-monospace,
      SFMono-Regular,
      Menlo,
      Monaco,
      Consolas,
      "Liberation Mono",
      "Courier New",
      monospace;
  }
  pre {
    white-space: pre-wrap;
    word-break: break-word;
  }
  .row {
    margin: 10px 0;
  }
  input,
  button {
    font: inherit;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #121212;
    color: #eee;
  }
  button {
    background: #00ffc6;
    color: #001;
    border: none;
    font-weight: 700;
  }
</style>
<div class="row">
  <input id="msg" size="50" placeholder="message" value="hello from probe" />
  <input id="uid" size="16" placeholder="userId" value="web" />
  <input id="agent" size="16" placeholder="agent" value="keilani" />
  <button id="go">Connect</button>
</div>
<pre id="out">[connecting…]</pre>
<script>
  const out = document.getElementById("out");
  const go = document.getElementById("go");

  function log(obj) {
    out.textContent +=
      "\n" + (typeof obj === "string" ? obj : JSON.stringify(obj));
  }

  function connect() {
    out.textContent = "[connecting…]";
    const q = new URLSearchParams({
      message: document.getElementById("msg").value,
      userId: document.getElementById("uid").value,
      agent: document.getElementById("agent").value,
    });
    // GET-based SSE so EventSource can attach
    const url = `/api/chat-stream?${q.toString()}`;
    const es = new EventSource(url, { withCredentials: false });

    es.addEventListener("message", (ev) => {
      try {
        log(JSON.parse(ev.data));
      } catch {
        log(ev.data);
      }
    });

    es.addEventListener("error", (err) => {
      log("[eventsource error]");
      es.close();
    });
  }

  go.addEventListener("click", connect);
</script>
