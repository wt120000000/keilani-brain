<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keilani • Chat (Streaming)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" href="/favicon.ico" />
    <!-- Local vendor styles -->
    <link rel="stylesheet" href="./vendor/github-dark.min.css" />
    <style>
      :root {
        --bg: #0d1117;
        --panel: #111827;
        --panel-2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #8b5cf6;
        --accent-2: #7c3aed;
        --danger: #ef4444;
        --border: #1f2937;
        --chip: #0b1220;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        color: var(--text);
        background:
          radial-gradient(1200px 400px at 20% 0, #0b1530, transparent),
          radial-gradient(900px 300px at 80% -10%, #1b1142, transparent),
          var(--bg);
        font:
          14px/1.45 ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Inter,
          "Helvetica Neue",
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        letter-spacing: 0.2px;
      }

      .bar {
        display: flex;
        gap: 10px;
        padding: 12px;
        align-items: center;
        border-bottom: 1px solid var(--border);
      }
      .title {
        display: flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 12px;
        background: var(--panel-2);
        font-weight: 600;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 2px #0a0a0a inset;
      }
      .pill {
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
      }
      .pill input {
        background: transparent;
        border: 0;
        outline: none;
        color: var(--text);
        width: 100%;
      }
      .select,
      select,
      button {
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: 8px 10px;
      }
      select {
        cursor: pointer;
      }
      .ghost {
        background: transparent;
        border-color: var(--border);
      }
      .danger {
        background: #231318;
        border-color: #3b121b;
        color: #fecaca;
      }
      .btn {
        cursor: pointer;
        transition:
          0.15s transform,
          0.15s background,
          0.15s border-color,
          0.15s opacity;
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0);
      }

      .wrap {
        height: calc(100% - 58px);
        display: flex;
        flex-direction: column;
      }
      .meta {
        padding: 8px 12px;
        display: flex;
        gap: 10px;
        align-items: center;
        color: var(--muted);
      }
      .chip {
        background: var(--chip);
        color: #c7d2fe;
        border: 1px solid #1f2a44;
        padding: 6px 10px;
        border-radius: 999px;
        font-variant-numeric: tabular-nums;
      }
      .messages {
        flex: 1;
        overflow: auto;
        padding: 10px 12px 0;
      }
      .bubble {
        background: var(--panel);
        border: 1px solid var(--border);
        padding: 14px 14px;
        border-radius: 12px;
        margin: 10px 8px;
        max-width: 1100px;
      }
      .bubble.me {
        background: #0c1330;
        border-color: #1a1e3a;
      }
      .bubble.error {
        background: #1c0f14;
        border-color: #31121a;
        color: #fecaca;
      }
      .role {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .mono {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      .composer {
        border-top: 1px solid var(--border);
        padding: 12px;
      }
      .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }
      textarea {
        flex: 1;
        min-height: 56px;
        max-height: 240px;
        resize: vertical;
        border-radius: 12px;
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 12px 12px;
        outline: none;
      }
      .send {
        background: var(--accent);
        border-color: #2b1f59;
      }
      .send:hover {
        background: var(--accent-2);
      }
      .hint {
        padding: 10px 2px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }
      .right {
        margin-left: auto;
      }
      code,
      pre code {
        font-size: 12.5px;
      }
      pre {
        background: #0b1020;
        border: 1px solid #1c2842;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
      }
      .kbd {
        padding: 2px 6px;
        border-radius: 6px;
        background: #0c1330;
        border: 1px solid #1a1e3a;
        color: #c7d2fe;
        font-size: 11px;
      }
      .switch {
        display: inline-flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
      }
      .switch input {
        width: 14px;
        height: 14px;
        accent-color: var(--accent);
      }
    </style>
  </head>
  <body>
    <div class="bar">
      <div class="title">
        <span class="status-dot"></span><span>Keilani Chat</span
        ><span class="mono">•</span><span>Streaming</span>
      </div>

      <select id="model" class="select">
        <option value="gpt-5" selected>gpt-5</option>
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="o4-mini">o4-mini</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
      </select>

      <div class="pill" style="min-width: 420px; max-width: 48vw">
        <input
          id="api"
          value="https://api.keilani.ai/api/chat"
          spellcheck="false"
        />
      </div>

      <div class="pill" style="min-width: 280px">
        <input
          id="token"
          placeholder="Client Token (optional)"
          spellcheck="false"
        />
      </div>

      <button class="btn" id="save">Save</button>
      <button class="btn ghost" id="export">Export .txt</button>
      <button class="btn ghost" id="clear">Clear</button>
      <button class="btn ghost" id="reset">Reset Session</button>

      <label class="switch right">
        <input type="checkbox" id="stream" checked /> <span>Stream</span>
      </label>
      <label class="switch">
        <input type="checkbox" id="sse" checked /> <span>Expect SSE</span>
      </label>
    </div>

    <div class="wrap">
      <div class="meta">
        <div class="chip">
          Tokens: <span id="tok">0</span> • <span id="tps">0</span>/s
        </div>
        <div class="chip">SID: <span id="sid">–</span></div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="composer">
        <div class="input-row">
          <textarea
            id="prompt"
            placeholder="Type your message…  (Enter to send • Shift+Enter for newline)"
          ></textarea>
          <button id="send" class="btn send">Send ↵</button>
        </div>
        <div class="hint">
          Tip: <span class="kbd">Ctrl/Cmd+K</span> to focus input • Your config
          persists locally
        </div>
      </div>
    </div>

    <!-- Local vendor scripts -->
    <script src="./vendor/dayjs.min.js"></script>
    <script src="./vendor/marked.umd.min.js"></script>
    <script src="./vendor/highlight.min.js"></script>

    <script>
      // ---------- tiny helpers ----------
      const $ = (s, r = document) => r.querySelector(s);
      const on = (el, ev, fn) => el.addEventListener(ev, fn);
      const storage = {
        get(k, d = null) {
          try {
            return JSON.parse(localStorage.getItem(k)) ?? d;
          } catch {
            return d;
          }
        },
        set(k, v) {
          localStorage.setItem(k, JSON.stringify(v));
        },
      };

      const ui = {
        model: $("#model"),
        api: $("#api"),
        token: $("#token"),
        stream: $("#stream"),
        sse: $("#sse"),
        sendBtn: $("#send"),
        txt: $("#prompt"),
        list: $("#messages"),
        tok: $("#tok"),
        tps: $("#tps"),
        sid: $("#sid"),
        save: $("#save"),
        clear: $("#clear"),
        reset: $("#reset"),
        export: $("#export"),
      };

      const state = {
        sid: Math.random().toString(36).slice(2, 10),
        tokens: 0,
        lastTick: 0,
      };

      function setSID(v) {
        state.sid = v;
        ui.sid.textContent = v;
      }
      setSID(storage.get("SID") || state.sid);

      // persist + restore
      (function restore() {
        const m = storage.get("MODEL");
        if (m) ui.model.value = m;
        const a = storage.get("API");
        if (a) ui.api.value = a;
        const t = storage.get("CLIENT_TOKEN");
        if (t) ui.token.value = t;
        const st = storage.get("STREAM");
        if (typeof st === "boolean") ui.stream.checked = st;
        const se = storage.get("SSE");
        if (typeof se === "boolean") ui.sse.checked = se;
      })();

      function persist() {
        storage.set("MODEL", ui.model.value);
        storage.set("API", ui.api.value.trim());
        storage.set("CLIENT_TOKEN", ui.token.value.trim());
        storage.set("STREAM", ui.stream.checked);
        storage.set("SSE", ui.sse.checked);
        storage.set("SID", state.sid);
      }
      on(ui.save, "click", persist);

      // keyboard affordances
      on(document, "keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          ui.txt.focus();
        }
      });

      // message rendering (markdown + highlight)
      function md(htmlStr) {
        try {
          const out = window.marked.parse(htmlStr, { breaks: true, gfm: true });
          const div = document.createElement("div");
          div.innerHTML = out;
          div.querySelectorAll("pre code").forEach((block) => {
            try {
              window.hljs.highlightElement(block);
            } catch {}
          });
          return div.innerHTML;
        } catch {
          return htmlStr.replace(
            /[&<>]/g,
            (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" })[s],
          );
        }
      }

      function bubble(role, text, kind = "normal") {
        const wrap = document.createElement("div");
        wrap.className =
          "bubble" +
          (role === "You" ? " me" : "") +
          (kind === "error" ? " error" : "");
        wrap.innerHTML = `
      <div class="role">${role} • <span class="mono">${dayjs().format("h:mm:ss A")}</span></div>
      <div class="content">${md(text)}</div>
    `;
        ui.list.appendChild(wrap);
        ui.list.scrollTop = ui.list.scrollHeight;
        return wrap.querySelector(".content");
      }

      function errorBox(text) {
        bubble("Error", text, "error");
      }

      function now() {
        return performance.now();
      }

      // build messages array from DOM (simple transcript → user/assistant turns)
      function collectMessages() {
        const items = Array.from(ui.list.querySelectorAll(".bubble .role")).map(
          (r) => {
            const who = r.textContent.split("•")[0].trim();
            const content =
              r.parentElement.querySelector(".content").textContent;
            return { role: /You/i.test(who) ? "user" : "assistant", content };
          },
        );
        return items;
      }

      async function sendMessage() {
        const api = ui.api.value.trim();
        const model = ui.model.value;
        const text = ui.txt.value.trim();
        if (!text) return;

        ui.sendBtn.disabled = true;
        persist();

        // render "me"
        bubble("You", text);
        ui.txt.value = "";

        // ask
        const outEl = bubble("Keilani", ""); // will stream in

        const body = {
          model,
          messages: [...collectMessages(), { role: "user", content: text }],
          stream: ui.stream.checked,
          client_token: ui.token.value.trim() || undefined,
        };

        // start timer for token/s readout
        const started = now();
        function tickTokens(nInc = 0) {
          state.tokens += nInc;
          ui.tok.textContent = state.tokens;
          const sec = Math.max(0.05, (now() - started) / 1000);
          ui.tps.textContent = (state.tokens / sec).toFixed(1);
        }

        try {
          const headers = { "Content-Type": "application/json" };
          const res = await fetch(api, {
            method: "POST",
            headers,
            body: JSON.stringify(body),
          });

          // handle SSE
          if (
            ui.stream.checked &&
            ui.sse.checked &&
            res.ok &&
            res.headers.get("content-type")?.includes("text/event-stream")
          ) {
            const reader = res.body.getReader();
            const dec = new TextDecoder();
            let buf = "",
              done = false;

            while (!done) {
              const { value, done: doneChunk } = await reader.read();
              done = doneChunk;
              buf += dec.decode(value || new Uint8Array(), { stream: !done });
              let idx;
              while ((idx = buf.indexOf("\n\n")) !== -1) {
                const frame = buf.slice(0, idx);
                buf = buf.slice(idx + 2);
                if (!frame.startsWith("data:")) continue;
                const payload = frame.slice(5).trim();
                if (payload === "[DONE]") {
                  tickTokens();
                  continue;
                }

                try {
                  const json = JSON.parse(payload);
                  const delta = json?.choices?.[0]?.delta?.content ?? "";
                  if (delta) {
                    outEl.insertAdjacentText("beforeend", delta);
                    tickTokens(delta.split(/\s+/).length);
                  }
                } catch (e) {
                  /* ignore frame parse errors */
                }
              }
            }
          } else {
            // non-stream JSON
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              throw new Error(
                data?.error?.message || res.statusText || "HTTP " + res.status,
              );
            }
            const textOut =
              data?.choices?.[0]?.message?.content ?? JSON.stringify(data);
            outEl.textContent = "";
            outEl.insertAdjacentHTML("beforeend", md(textOut));
            tickTokens(String(textOut).split(/\s+/).length);
          }
        } catch (err) {
          errorBox(`[Error] ${String(err?.message || err)}`);
        } finally {
          ui.sendBtn.disabled = false;
        }
      }

      // wire up
      on(ui.sendBtn, "click", sendMessage);
      on(ui.txt, "keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      on(ui.clear, "click", () => {
        ui.list.innerHTML = "";
        state.tokens = 0;
        ui.tok.textContent = "0";
        ui.tps.textContent = "0";
      });
      on(ui.reset, "click", () => {
        setSID(Math.random().toString(36).slice(2, 10));
        persist();
        ui.list.innerHTML = "";
        state.tokens = 0;
        ui.tok.textContent = "0";
        ui.tps.textContent = "0";
      });
      on(ui.export, "click", () => {
        let text = "";
        ui.list.querySelectorAll(".bubble").forEach((b) => {
          const who =
            b.querySelector(".role")?.textContent?.split("•")[0].trim() || "";
          const msg = b.querySelector(".content")?.textContent || "";
          text += `${who}: ${msg}\n\n`;
        });
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), {
          href: url,
          download: `keilani_${dayjs().format("YYYYMMDD_HHmmss")}.txt`,
        });
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 500);
      });

      // small convenience: auto-focus prompt
      ui.txt.focus();
    </script>
  </body>
</html>
