<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>Keilani ‚Ä¢ Chat Streaming</title>
    <style>
      :root {
        --bg: #0c0f14;
        --panel: #121721;
        --muted: #8b93a7;
        --text: #e6eaf2;
        --accent: #7c5cff;
        --accent-2: #9d87ff;
        --error: #ff4d4d;
        --ok: #2ecc71;
        --chip: #1a2030;
        --bubble-user: #1a2232;
        --bubble-ai: #151d2b;
        --bubble-err: #2a1313;
        --border: #20293a;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font:
          14px/1.45 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 2;
        display: grid;
        grid-template-columns: 110px 1fr 1fr 220px auto auto auto auto;
        gap: 10px;
        padding: 12px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, #0c0f14 0%, #0c0f14cc 100%);
        backdrop-filter: saturate(140%) blur(8px);
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #0f1522;
        border: 1px solid var(--border);
        font-weight: 600;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--ok);
      }

      select,
      input[type="text"] {
        width: 100%;
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 8px 10px;
        border-radius: 10px;
        outline: none;
      }
      .token-eye {
        position: relative;
        display: flex;
        align-items: center;
      }
      .token-eye input {
        padding-right: 36px;
      }
      .token-eye button {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        border: 0;
        background: var(--chip);
        color: var(--muted);
        padding: 6px 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn {
        border: 1px solid var(--border);
        background: var(--chip);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--accent);
        border-color: #5e46d6;
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.warn {
        background: #2a1a1a;
        border-color: #3a1f1f;
        color: #ffb4b4;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .toggles {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: var(--muted);
      }
      .toggle input {
        transform: translateY(1px);
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 12px;
      }

      .log {
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: calc(100dvh - 220px);
        padding: 8px 0 16px;
      }
      .bubble {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .user {
        background: var(--bubble-user);
      }
      .assistant {
        background: var(--bubble-ai);
      }
      .error {
        background: var(--bubble-err);
        border-color: #513232;
        color: #ffbcbc;
      }

      .composer {
        position: sticky;
        bottom: 0;
        z-index: 1;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px 0 18px;
        background: linear-gradient(
          180deg,
          transparent 0%,
          #0c0f14 50%,
          #0c0f14 100%
        );
      }
      textarea {
        width: 100%;
        resize: vertical;
        min-height: 56px;
        max-height: 240px;
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 14px;
        padding: 12px 14px;
        outline: none;
      }

      .chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        color: var(--muted);
      }
      .chip {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
      }
      .sid {
        user-select: text;
      }
      .mono {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono",
          monospace;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="badge">
        <span class="dot"></span> Keilani Chat ‚Ä¢
        <span class="mono">Streaming</span>
      </div>

      <select id="model" title="Model">
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-4.1">gpt-4.1</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
      </select>

      <input
        id="api"
        type="text"
        placeholder="https://api.keilani.ai/api/chat"
      />

      <div class="token-eye">
        <input id="token" type="text" placeholder="Client Token (optional)" />
        <button type="button" id="peek">üëÅ</button>
      </div>

      <button id="save" class="btn">Save</button>
      <button id="export" class="btn">Export .txt</button>
      <button id="clear" class="btn">Clear</button>
      <button id="reset" class="btn">Reset Session</button>
    </div>

    <div class="wrap">
      <div class="chips">
        <span class="chip"
          >Tokens: <span id="tk">0</span> ‚Ä¢ <span id="tkr">0</span>/s</span
        >
        <span class="chip sid">SID: <span id="sid"></span></span>
        <label class="toggle"
          ><input type="checkbox" id="stream" checked /> Stream</label
        >
        <label class="toggle"
          ><input type="checkbox" id="sse" checked /> Expect SSE</label
        >
      </div>

      <div id="log" class="log" aria-live="polite"></div>

      <form id="form" class="composer">
        <textarea
          id="prompt"
          placeholder="Type your message‚Ä¶  (Shift+Enter for newline)"
        ></textarea>
        <button id="send" class="btn primary" type="submit">Send ‚Üµ</button>
      </form>
    </div>

    <script>
      // ---------- Persistence ----------
      const LS = {
        api: "CHAT_API",
        model: "CHAT_MODEL",
        token: "CLIENT_TOKEN",
        stream: "CHAT_STREAM",
        sse: "CHAT_SSE",
        sid: "CHAT_SID",
      };

      const $ = (s) => document.querySelector(s);
      const log = $("#log");
      const promptEl = $("#prompt");
      const tk = $("#tk");
      const tkr = $("#tkr");

      function uid() {
        return (
          Math.random().toString(36).slice(2, 10) +
          Math.random().toString(36).slice(2, 10)
        );
      }

      function loadConfig() {
        $("#api").value =
          localStorage.getItem(LS.api) || "https://api.keilani.ai/api/chat";
        $("#model").value = localStorage.getItem(LS.model) || "gpt-5";
        $("#token").value = localStorage.getItem(LS.token) || "";
        $("#stream").checked =
          (localStorage.getItem(LS.stream) ?? "true") === "true";
        $("#sse").checked = (localStorage.getItem(LS.sse) ?? "true") === "true";

        let sid = localStorage.getItem(LS.sid);
        if (!sid) {
          sid = uid();
          localStorage.setItem(LS.sid, sid);
        }
        $("#sid").textContent = sid;
      }

      function saveConfig() {
        localStorage.setItem(LS.api, $("#api").value.trim());
        localStorage.setItem(LS.model, $("#model").value.trim());
        localStorage.setItem(LS.token, $("#token").value.trim());
        localStorage.setItem(LS.stream, String($("#stream").checked));
        localStorage.setItem(LS.sse, String($("#sse").checked));
        toast("Saved ‚úÖ");
      }

      function resetSession() {
        const sid = uid();
        localStorage.setItem(LS.sid, sid);
        $("#sid").textContent = sid;
        toast("Session reset");
      }

      function toast(msg) {
        console.log("[toast]", msg);
      }

      // ---------- UI helpers ----------
      function addBubble(role, text) {
        const el = document.createElement("div");
        el.className = "bubble " + role;
        el.textContent = text ?? "";
        log.appendChild(el);
        log.parentElement.scrollTop = log.parentElement.scrollHeight;
        return el;
      }
      function setBubble(el, text) {
        el.textContent = text ?? "";
      }

      // ---------- Networking ----------
      async function sendMessage(evt) {
        evt?.preventDefault?.();

        const api = $("#api").value.trim();
        const model = $("#model").value.trim();
        const token = (
          $("#token").value ||
          localStorage.getItem(LS.token) ||
          ""
        ).trim();
        const wantStream = $("#stream").checked; // advisory only; server decides
        const expectSSE = $("#sse").checked; // UI hint; we still sniff content-type
        const sid = localStorage.getItem(LS.sid);

        const text = promptEl.value.trim();
        if (!text) return;

        // user bubble
        addBubble("user", text);
        promptEl.value = "";

        // Build OpenAI-style payload. IMPORTANT: messages[] (not "message").
        const payload = {
          model: model || "gpt-4o-mini",
          messages: [{ role: "user", content: text }],
          stream: !!wantStream,
          // metadata for your proxy (optional)
          session_id: sid,
        };

        // POST to your proxy
        const headers = { "Content-Type": "application/json" };
        if (token) headers["Authorization"] = `Bearer ${token}`;

        let res;
        try {
          res = await fetch(api, {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });
        } catch (e) {
          addBubble("error", `Network error: ${e.message}`);
          return;
        }

        const ct = (res.headers.get("content-type") || "").toLowerCase();

        // --- Streaming (SSE) path ---
        if (ct.includes("text/event-stream")) {
          let acc = "";
          const bubble = addBubble("assistant", "");
          let totalTokens = 0;
          try {
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, { stream: true });

              // Basic SSE parsing
              for (const raw of chunk.split("\n")) {
                const line = raw.trim();
                if (!line || !line.startsWith("data:")) continue;
                const data = line.slice(5).trim();
                if (data === "[DONE]") continue;

                try {
                  const msg = JSON.parse(data);
                  // OpenAI responses
                  const delta = msg?.choices?.[0]?.delta?.content ?? "";
                  if (delta) {
                    acc += delta;
                    setBubble(bubble, acc);
                  }
                  // If your proxy emits token counts
                  if (typeof msg?.usage?.total_tokens === "number") {
                    totalTokens = msg.usage.total_tokens;
                    tk.textContent = totalTokens;
                  }
                } catch {
                  // tolerate non-JSON SSE lines
                }
              }
            }
          } catch (err) {
            addBubble("error", `Stream error: ${err.message}`);
          }
          if (!res.ok) addBubble("error", `[Error] HTTP ${res.status}`);
          return;
        }

        // --- JSON (single response) path ---
        let json;
        try {
          json = await res.json();
        } catch {
          const bodyText = await res.text();
          addBubble("error", `Unexpected body: ${bodyText?.slice(0, 600)}`);
          return;
        }

        // Unwrap content from common shapes
        const content =
          json?.choices?.[0]?.message?.content ??
          json?.message ??
          json?.output ??
          (typeof json === "string" ? json : JSON.stringify(json));

        addBubble("assistant", content);
        if (json?.usage?.total_tokens != null)
          tk.textContent = json.usage.total_tokens;

        if (!res.ok) addBubble("error", `[Error] HTTP ${res.status}`);
      }

      // ---------- Wire up ----------
      $("#form").addEventListener("submit", sendMessage);
      $("#send").addEventListener("click", sendMessage);
      $("#prompt").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      $("#save").addEventListener("click", saveConfig);
      $("#reset").addEventListener("click", resetSession);
      $("#clear").addEventListener("click", () => {
        log.innerHTML = "";
        tk.textContent = "0";
        tkr.textContent = "0";
      });

      $("#export").addEventListener("click", () => {
        const lines = Array.from(log.children)
          .map((el) => {
            const role = el.className.includes("user")
              ? "You"
              : el.className.includes("assistant")
                ? "Keilani"
                : "Error";
            return `${role}: ${el.textContent}`;
          })
          .join("\n\n");
        const blob = new Blob([lines], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `keilani_chat_${new Date().toISOString().replace(/[:.]/g, "-")}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      });

      // peek/hide token
      $("#peek").addEventListener("click", () => {
        const t = $("#token");
        if (t.type === "password") {
          t.type = "text";
          $("#peek").textContent = "üôà";
        } else {
          t.type = "password";
          $("#peek").textContent = "üëÅ";
        }
      });

      // Initialize
      loadConfig();
      // Mask token input visually but keep value intact
      if ($("#token").value) $("#token").setAttribute("type", "password");

      // Focus
      promptEl.focus();
    </script>
  </body>
</html>
