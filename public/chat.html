<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keilani • Chat Streaming</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          sans-serif;
        background: #0a0a0a;
        color: #eee;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        background: #111;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      header input,
      header select {
        background: #222;
        border: 1px solid #333;
        color: #eee;
        padding: 6px 8px;
        border-radius: 6px;
      }
      header button {
        background: #333;
        border: none;
        color: #eee;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
      }
      #chat {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
      }
      .msg {
        margin: 8px 0;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        white-space: pre-wrap;
      }
      .you {
        background: #222;
        align-self: flex-end;
      }
      .keilani {
        background: #1a1a2e;
        border-left: 3px solid #8a2be2;
        align-self: flex-start;
      }
      .error {
        background: #331111;
        border-left: 3px solid #e22;
        color: #f99;
      }
      #composer {
        display: flex;
        padding: 10px;
        background: #111;
      }
      #prompt {
        flex: 1;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #333;
        background: #222;
        color: #eee;
      }
      #send {
        margin-left: 8px;
        background: #6c2bd9;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
      }
      #status {
        font-size: 12px;
        color: #aaa;
        padding: 4px 10px;
        background: #111;
      }
    </style>
  </head>
  <body>
    <header>
      <span style="color: #0f0">●</span> Keilani Chat • Streaming
      <select id="model">
        <option value="gpt-5">gpt-5</option>
        <option value="gpt-4.1">gpt-4.1</option>
      </select>
      <input id="api" value="https://api.keilani.ai/api/chat" style="flex: 1" />
      <input id="token" placeholder="Client Token" />
      <button id="save">Save</button>
      <button id="export">Export .txt</button>
      <button id="clear">Clear</button>
    </header>

    <div id="chat"></div>
    <div id="status">Tokens: 0 • 0 t/s</div>

    <form id="composer">
      <textarea
        id="prompt"
        placeholder="Type your message… (Shift+Enter for newline)"
      ></textarea>
      <button id="send">Send ↵</button>
    </form>

    <script>
      const chatEl = document.getElementById("chat");
      const statusEl = document.getElementById("status");
      const promptEl = document.getElementById("prompt");
      const form = document.getElementById("composer");
      const sendBtn = document.getElementById("send");

      // restore config + chats
      document.getElementById("api").value =
        localStorage.getItem("API") || "https://api.keilani.ai/api/chat";
      document.getElementById("token").value =
        localStorage.getItem("CLIENT_TOKEN") || "";
      document.getElementById("model").value =
        localStorage.getItem("MODEL") || "gpt-5";
      chatEl.innerHTML = localStorage.getItem("CHAT_HISTORY") || "";

      // save config
      document.getElementById("save").onclick = () => {
        localStorage.setItem(
          "API",
          document.getElementById("api").value.trim(),
        );
        localStorage.setItem(
          "CLIENT_TOKEN",
          document.getElementById("token").value.trim(),
        );
        localStorage.setItem("MODEL", document.getElementById("model").value);
        alert("Saved!");
      };

      // export chat
      document.getElementById("export").onclick = () => {
        const blob = new Blob([chatEl.innerText], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "chat.txt";
        a.click();
      };

      // clear chat
      document.getElementById("clear").onclick = () => {
        chatEl.innerHTML = "";
        localStorage.removeItem("CHAT_HISTORY");
      };

      async function sendMessage(msg) {
        const api = document.getElementById("api").value.trim();
        const token = document.getElementById("token").value.trim();
        const model = document.getElementById("model").value;

        // user bubble
        const you = document.createElement("div");
        you.className = "msg you";
        you.textContent = msg;
        chatEl.appendChild(you);
        chatEl.scrollTop = chatEl.scrollHeight;

        // keilani bubble
        const bot = document.createElement("div");
        bot.className = "msg keilani";
        chatEl.appendChild(bot);
        chatEl.scrollTop = chatEl.scrollHeight;

        // persist history
        localStorage.setItem("CHAT_HISTORY", chatEl.innerHTML);

        try {
          const res = await fetch(api, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token ? `Bearer ${token}` : "",
            },
            body: JSON.stringify({
              model,
              stream: true,
              messages: [{ role: "user", content: msg }],
            }),
          });

          if (!res.ok) throw new Error("HTTP " + res.status);

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";
          let tokens = 0;
          const start = Date.now();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            const parts = buffer.split("\n\n");
            buffer = parts.pop();

            for (let p of parts) {
              if (p.startsWith("data: ")) {
                const data = p.slice(6).trim();
                if (data === "[DONE]") continue;
                try {
                  const json = JSON.parse(data);
                  const delta = json?.choices?.[0]?.delta?.content || "";
                  if (delta) {
                    bot.textContent += delta;
                    chatEl.scrollTop = chatEl.scrollHeight;
                    tokens += delta.split(/\s+/).length;
                    const elapsed = (Date.now() - start) / 1000;
                    statusEl.textContent = `Tokens: ${tokens} • ${(tokens / elapsed).toFixed(1)} t/s`;
                    localStorage.setItem("CHAT_HISTORY", chatEl.innerHTML);
                  }
                } catch (e) {}
              }
            }
          }
        } catch (err) {
          bot.className = "msg error";
          bot.textContent = "[Error] " + err.message;
        }
      }

      // handle form
      form.onsubmit = (e) => {
        e.preventDefault();
        const msg = promptEl.value.trim();
        if (!msg) return;
        promptEl.value = "";
        sendMessage(msg);
      };
    </script>
  </body>
</html>
