<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keilani • Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b0a0f;
        --panel: #11101a;
        --panel-2: #151426;
        --line: #24223b;
        --user-grad: linear-gradient(135deg, #6ea8ff, #a879ff 60%, #ff70d0);
        --ai-bg: #0d0d14;
        --ai-text: #b7ff68; /* neon lime */
        --ai-glow: 0 0 12px #aefe53, 0 0 28px rgba(174, 254, 83, 0.25);
        --muted: #8c8aa3;
        --ink: #e8e7ef;
        --accent: #ff70d0; /* pink sparkle */
        --accent-2: #6ea8ff; /* electric blue */
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font:
          16px/1.45 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        color: var(--ink);
        background:
          radial-gradient(
            1200px 600px at 15% -10%,
            rgba(110, 168, 255, 0.18),
            transparent 60%
          ),
          radial-gradient(
            900px 500px at 100% 0%,
            rgba(255, 112, 208, 0.12),
            transparent 60%
          ),
          var(--bg);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 24px;
      }
      .app {
        width: min(920px, 100%);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .bar {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        box-shadow:
          0 10px 30px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.03);
      }
      .title {
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .pill {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--line);
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.02);
      }

      .threadWrap {
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: 14px;
        min-height: 52vh;
        max-height: 66vh;
        overflow: auto;
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.03),
          0 10px 30px rgba(0, 0, 0, 0.25);
      }
      ul#messages {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .msg {
        max-width: 78%;
        padding: 10px 12px;
        border-radius: var(--radius);
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .msg.user {
        align-self: flex-end;
        color: #fff;
        background: var(--user-grad);
        position: relative;
      }
      .msg.ai {
        align-self: flex-start;
        background: var(--ai-bg);
        color: var(--ai-text);
        box-shadow: var(--ai-glow);
      }
      .msg.sys {
        align-self: center;
        color: var(--muted);
        font-size: 14px;
        background: transparent;
      }

      /* bubble tails */
      .msg.user::after {
        content: "";
        position: absolute;
        right: -6px;
        bottom: 6px;
        width: 12px;
        height: 12px;
        background: inherit;
        transform: rotate(45deg);
        border-bottom-right-radius: 4px;
      }
      .msg.ai::before {
        content: "";
        position: absolute;
        left: -6px;
        bottom: 6px;
        width: 12px;
        height: 12px;
        background: var(--ai-bg);
        transform: rotate(45deg);
      }

      .composer {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 10px;
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 12px;
        box-shadow:
          0 10px 30px rgba(0, 0, 0, 0.25),
          inset 0 1px 0 rgba(255, 255, 255, 0.03);
      }
      input#msg,
      textarea#msg {
        resize: none;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px 12px;
        background: #0c0b14;
        color: var(--ink);
        outline: none;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
      }
      button {
        border: 1px solid var(--line);
        background: #0f0e1a;
        color: var(--ink);
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, var(--accent-2), var(--accent) 80%);
        color: #fff;
        border: none;
        box-shadow: 0 8px 24px rgba(255, 112, 208, 0.28);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* typing dots */
      .typing {
        display: inline-flex;
        gap: 6px;
        align-items: center;
      }
      .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--ai-text);
        opacity: 0.5;
        box-shadow: var(--ai-glow);
      }
      .dot:nth-child(1) {
        animation: bounce 1s infinite 0s;
      }
      .dot:nth-child(2) {
        animation: bounce 1s infinite 0.15s;
      }
      .dot:nth-child(3) {
        animation: bounce 1s infinite 0.3s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        40% {
          transform: translateY(-5px);
          opacity: 1;
        }
      }

      .muted {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="bar">
        <div class="title">Keilani ✨</div>
        <div class="pill" id="statusPill">Ready</div>
      </div>

      <div class="threadWrap">
        <ul id="messages"></ul>
      </div>

      <form id="composer" class="composer">
        <textarea
          id="msg"
          rows="2"
          placeholder="Tell Keilani something cute… (Enter to send, Shift+Enter = newline)"
        ></textarea>
        <button id="sendBtn" class="primary" type="submit">Send</button>
        <button id="stopBtn" type="button">Stop</button>
      </form>
    </div>

    <script type="module">
      // Set this if hosting the API elsewhere; empty = same origin.
      const API_BASE = ""; // e.g., "https://api.keilani.ai"

      const $ = (s) => document.querySelector(s);
      const messagesEl = $("#messages");
      const input = $("#msg");
      const sendBtn = $("#sendBtn");
      const stopBtn = $("#stopBtn");
      const statusPill = $("#statusPill");

      const userId =
        localStorage.getItem("kb_user") ||
        (() => {
          const id = crypto.randomUUID?.() || String(Date.now());
          localStorage.setItem("kb_user", id);
          return id;
        })();

      // conversation history for context
      const history = [
        {
          role: "system",
          content: "You are Keilani: concise, flirty-fun, helpful.",
        },
      ];

      let cancelCurrent = null;

      function pill(text, muted = false) {
        statusPill.textContent = text;
        statusPill.classList.toggle("muted", !!muted);
      }

      function addBubble(text, who) {
        const li = document.createElement("li");
        const div = document.createElement("div");
        div.className = `msg ${who}`;
        div.textContent = text;
        li.appendChild(div);
        messagesEl.appendChild(li);
        div.scrollIntoView({ behavior: "smooth", block: "end" });
        return div;
      }

      function addTyping() {
        const li = document.createElement("li");
        const div = document.createElement("div");
        div.className = "msg ai";
        div.innerHTML = `<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
        li.appendChild(div);
        messagesEl.appendChild(li);
        div.scrollIntoView({ behavior: "smooth", block: "end" });
        return { li, div };
      }

      async function streamEdge(messages, bubble, signal) {
        const body = { userId, messages, message: messages.at(-1)?.content }; // be compatible with either server shape
        const res = await fetch((API_BASE || "") + "/api/chat-stream", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
          signal,
        });
        if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`);

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let full = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = dec.decode(value, { stream: true });
          for (const line of chunk.split("\n")) {
            if (!line.startsWith("data: ")) continue;
            const payload = line.slice(6).trim();
            if (!payload || payload === "[DONE]") continue;
            try {
              const json = JSON.parse(payload);
              const delta = json?.choices?.[0]?.delta?.content;
              if (delta) {
                full += delta;
                bubble.textContent += delta;
                bubble.scrollIntoView({ behavior: "smooth", block: "end" });
              }
            } catch {
              /* ignore keepalives */
            }
          }
        }
        return full;
      }

      async function callFallback(message) {
        const res = await fetch((API_BASE || "") + "/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-request-id": crypto.randomUUID?.() || String(Date.now()),
          },
          body: JSON.stringify({ userId, message }),
        });
        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {}
        if (!res.ok)
          throw new Error(
            `API ${data?.stage || "error"}: ${data?.error || text}`,
          );
        return data.reply || "(no reply)";
      }

      async function onSend(e) {
        e?.preventDefault?.();
        const message = (input.value || "").trim();
        if (!message) return;

        // user bubble
        addBubble(message, "user");
        history.push({ role: "user", content: message });
        input.value = "";
        input.focus();

        // assistant bubble with typing
        const { li, div: typingDiv } = addTyping();
        sendBtn.disabled = true;
        stopBtn.disabled = false;
        pill("Streaming…");

        // prepare streaming target bubble (replace typing)
        const aiBubble = document.createElement("div");
        aiBubble.className = "msg ai";
        li.replaceChild(aiBubble, typingDiv);

        const aborter = new AbortController();
        cancelCurrent = () => aborter.abort();

        try {
          const full = await streamEdge(history, aiBubble, aborter.signal);
          history.push({ role: "assistant", content: full });
          pill("OK • streamed", true);
        } catch (err) {
          if (err.name === "AbortError") {
            aiBubble.classList.add("dim");
            aiBubble.textContent += "\n[stopped]";
            pill("Stopped", true);
          } else {
            pill("Edge failed, fallback…");
            try {
              const reply = await callFallback(message);
              aiBubble.textContent = reply;
              history.push({ role: "assistant", content: reply });
              pill("OK • fallback", true);
            } catch (e2) {
              aiBubble.classList.add("dim");
              aiBubble.textContent += `\n[error] ${e2.message || e2}`;
              pill("Error", true);
              console.error(err, e2);
            }
          }
        } finally {
          sendBtn.disabled = false;
          stopBtn.disabled = true;
          cancelCurrent = null;
        }
      }

      // Events
      $("#composer").addEventListener("submit", onSend);
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          onSend(e);
        }
      });
      stopBtn.addEventListener("click", () => cancelCurrent?.());
    </script>
  </body>
</html>
