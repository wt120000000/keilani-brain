<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Keilani Chat • Streaming</title>

    <!-- Local vendor assets (no CDN) -->
    <link rel="stylesheet" href="/vendor/github-dark.min.css" />
    <script src="/vendor/dayjs.min.js"></script>
    <script src="/vendor/highlight.min.js"></script>
    <script src="/vendor/marked.umd.min.js"></script>

    <style>
      :root {
        --bg: #0b0f1a;
        --bg2: #0f1524;
        --panel: #0e1422;
        --card: #10192c;
        --ink: #e7ecf8;
        --ink-dim: #a8b3cf;
        --brand: #8055ff;
        --brand-2: #9b6bff;
        --ok: #41d18e;
        --err: #ff5c7a;
        --muted: #506079;
        --chip: #1a2540;
        --chip-ink: #c8d2eb;
        --input: #0f1524;
        --input-br: #1f2a44;
        --ring: #2d3a5f;
        --kbd: #0b1222;
        --kbd-br: #1c2743;
        --radius: 14px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background:
          radial-gradient(1200px 600px at 10% -10%, #12224a55, transparent 60%),
          radial-gradient(1200px 600px at 110% 10%, #3a1f7a44, transparent 60%),
          var(--bg);
        color: var(--ink);
        font:
          14px/1.45 system-ui,
          Segoe UI,
          Roboto,
          Inter,
          Helvetica,
          Arial,
          sans-serif;
      }
      .topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(180deg, #0b0f1acc, #0b0f1a00 100%);
        backdrop-filter: saturate(140%) blur(6px);
        padding: 10px 14px;
        border-bottom: 1px solid #11182b;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .grow {
        flex: 1 1 auto;
        min-width: 240px;
      }
      .btn,
      .chip,
      .input {
        border-radius: 12px;
        border: 1px solid var(--input-br);
        background: var(--input);
        color: var(--ink);
        height: 36px;
        padding: 8px 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn {
        background: linear-gradient(180deg, #1a2342, #131c33);
        border-color: #233054;
        box-shadow:
          0 1px 0 #000 inset,
          0 1px 0 #1a2342;
      }
      .btn:hover {
        border-color: #345089;
      }
      .btn--prime {
        background: linear-gradient(180deg, #6f52ff, #5b3cff);
        border-color: #745bff;
        color: white;
      }
      .select,
      .input {
        appearance: none;
        outline: 0;
      }
      .select {
        padding-right: 28px;
        background:
          linear-gradient(180deg, #141b2f, #0f1324),
          url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="%23a8b3cf" d="M7 10l5 5 5-5z"/></svg>')
            no-repeat right 10px center;
      }
      .switch {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #0d1424;
        border: 1px solid #1c2744;
        color: var(--ink-dim);
      }
      .switch input {
        accent-color: var(--brand);
      }
      .hud {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--ink-dim);
      }
      .chip {
        background: var(--chip);
        border-color: #223357;
        color: var(--chip-ink);
        height: 28px;
        padding: 4px 10px;
      }
      .log {
        max-width: 1100px;
        margin: 10px auto 0;
        padding: 0 14px;
      }
      .bubble {
        background: var(--card);
        border: 1px solid #1b2542;
        border-radius: 16px;
        padding: 14px 16px;
        margin: 12px auto 0;
        max-width: 1100px;
        box-shadow: 0 1px #0a0f1f;
      }
      .bubble.you {
        background: #0e1527;
        border-color: #1d2747;
      }
      .bubble.error {
        border-color: #5f2134;
        background: linear-gradient(180deg, #2a0f1a, #1a0b12);
        color: #ffd0da;
      }
      .msglist {
        min-height: 180px;
      }
      .composer {
        max-width: 1100px;
        margin: 16px auto;
        padding: 0 14px;
      }
      textarea {
        width: 100%;
        min-height: 56px;
        max-height: 45vh;
        resize: vertical;
        border-radius: 16px;
        border: 1px solid #1b2745;
        background: #0f1525;
        color: var(--ink);
        padding: 14px 16px;
        font: 14px/1.45 inherit;
        outline: none;
        box-shadow: 0 1px #0a0f1f;
      }
      .composer-bar {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
      }
      .right {
        margin-left: auto;
      }
      .muted {
        color: var(--ink-dim);
      }
      kbd {
        background: var(--kbd);
        border: 1px solid var(--kbd-br);
        padding: 1px 6px;
        border-radius: 6px;
        color: #b9c6e3;
      }
      pre {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid #233155;
        background: #0c1427;
        padding: 12px;
      }
      code {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .inspector {
        white-space: pre-wrap;
        font-family: ui-monospace, Consolas, monospace;
        background: #0c111d;
        border: 1px solid #1a2236;
        border-radius: 12px;
        padding: 10px;
        color: #a8b3cf;
      }
      .fade {
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="row">
        <div class="hud">
          <strong>Keilani Chat</strong><span class="fade">•</span
          ><span class="muted">Streaming</span>
        </div>

        <select id="model" class="select">
          <option value="gpt-5">gpt-5</option>
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="gpt-4o-mini">gpt-4o-mini</option>
        </select>

        <input
          id="api"
          class="input grow"
          placeholder="https://api.keilani.ai/api/chat"
        />

        <input
          id="token"
          class="input grow"
          placeholder="Client Token (optional)"
        />

        <button id="save" class="btn">Save</button>
        <button id="export" class="btn">Export .txt</button>
        <button id="clear" class="btn">Clear</button>
        <button id="reset" class="btn">Reset Session</button>

        <label class="switch"
          ><input id="stream" type="checkbox" checked /> Stream</label
        >
        <label class="switch"
          ><input id="sse" type="checkbox" checked /> Expect SSE</label
        >
      </div>

      <div class="row" style="margin-top: 8px">
        <span class="chip" id="tokhud">Tokens: 0 • 0/s</span>
        <span class="chip" id="sidhud">SID: —</span>
        <button id="inspectorBtn" class="btn">Raw Inspector</button>
      </div>
    </div>

    <main class="log" id="log">
      <!-- Messages render here -->
    </main>

    <section class="composer">
      <textarea
        id="prompt"
        placeholder="Type your message…  (Enter to send  •  Shift+Enter for newline)"
      ></textarea>
      <div class="composer-bar">
        <span class="muted"
          >Tip: <kbd>Ctrl/Cmd+K</kbd> to focus input • <kbd>↑</kbd> to edit last
          message</span
        >
        <button id="send" class="btn btn--prime right">Send ↵</button>
      </div>
      <div
        id="inspector"
        class="inspector"
        style="display: none; margin-top: 10px"
      ></div>
    </section>

    <script>
      (() => {
        // ---------- Utilities ----------
        const $ = (s, r = document) => r.querySelector(s);
        const $m = (s, r = document) => [...r.querySelectorAll(s)];
        const ls = (k, v = undefined) =>
          v === undefined
            ? localStorage.getItem(k)
            : localStorage.setItem(k, v);

        const ui = {
          model: $("#model"),
          api: $("#api"),
          token: $("#token"),
          save: $("#save"),
          exportBtn: $("#export"),
          clear: $("#clear"),
          reset: $("#reset"),
          stream: $("#stream"),
          sse: $("#sse"),
          tokhud: $("#tokhud"),
          sidhud: $("#sidhud"),
          log: $("#log"),
          prompt: $("#prompt"),
          send: $("#send"),
          inspector: $("#inspector"),
          inspectorBtn: $("#inspectorBtn"),
        };

        const state = {
          sid: crypto.randomUUID().slice(0, 8),
          messages: [],
          t0: 0,
          tokenCount: 0,
          lastChunkAt: 0,
        };

        const cfg = {
          get api() {
            return ui.api.value.trim() || "https://api.keilani.ai/api/chat";
          },
          get model() {
            return ui.model.value.trim() || "gpt-5";
          },
          get token() {
            return ui.token.value.trim();
          },
          get stream() {
            return ui.stream.checked;
          },
          get sse() {
            return ui.sse.checked;
          },
        };

        function persist() {
          ls("KLN_MODEL", cfg.model);
          ls("KLN_API", cfg.api);
          ls("KLN_TOKEN", cfg.token);
          ls("KLN_STREAM", cfg.stream ? "1" : "0");
          ls("KLN_SSE", cfg.sse ? "1" : "0");
        }
        function restore() {
          ui.model.value = ls("KLN_MODEL") || "gpt-5";
          ui.api.value = ls("KLN_API") || "https://api.keilani.ai/api/chat";
          ui.token.value = ls("KLN_TOKEN") || "";
          ui.stream.checked = (ls("KLN_STREAM") ?? "1") === "1";
          ui.sse.checked = (ls("KLN_SSE") ?? "1") === "1";
          ui.sidhud.textContent = `SID: ${state.sid}`;
        }

        function md(input) {
          try {
            // marked is UMD -> window.marked
            const out = window.marked?.parse(input) ?? input;
            const div = document.createElement("div");
            div.innerHTML = out;
            // syntax highlight
            $m("pre code", div).forEach((block) => {
              try {
                hljs.highlightElement(block);
              } catch {}
            });
            return div;
          } catch {
            const d = document.createElement("div");
            d.textContent = input;
            return d;
          }
        }

        function bubble(role, htmlNode, extraClass = "") {
          const wrap = document.createElement("div");
          wrap.className = `bubble ${role} ${extraClass}`.trim();
          wrap.appendChild(htmlNode);
          ui.log.appendChild(wrap);
          wrap.scrollIntoView({ behavior: "smooth", block: "end" });
          return wrap;
        }

        function textNode(s) {
          const p = document.createElement("div");
          p.textContent = s;
          return p;
        }
        function errNode(s) {
          const p = document.createElement("div");
          p.textContent = s;
          return p;
        }

        function updateHud() {
          const elapsed = Math.max(0, (Date.now() - state.t0) / 1000);
          const rate = elapsed ? (state.tokenCount / elapsed).toFixed(1) : "0";
          ui.tokhud.textContent = `Tokens: ${state.tokenCount} • ${rate}/s`;
        }

        function resetSession() {
          state.sid = crypto.randomUUID().slice(0, 8);
          state.messages = [];
          state.tokenCount = 0;
          ui.log.innerHTML = "";
          ui.sidhud.textContent = `SID: ${state.sid}`;
          updateHud();
        }

        // ---------- Render last-user-edit ----------
        ui.prompt.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            ui.send.click();
          } else if (e.key === "ArrowUp" && ui.prompt.value.trim() === "") {
            // edit last user message
            for (let i = state.messages.length - 1; i >= 0; i--) {
              if (state.messages[i].role === "user") {
                ui.prompt.value = state.messages[i].content;
                // remove its bubble & message so we resend edited
                const last = ui.log.lastElementChild;
                if (last) last.remove();
                state.messages.splice(i, 1);
                break;
              }
            }
          } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
            e.preventDefault();
            ui.prompt.focus();
          }
        });

        // ---------- Controls ----------
        ui.save.onclick = () => {
          persist();
          ui.save.textContent = "Saved";
          setTimeout(() => (ui.save.textContent = "Save"), 900);
        };
        ui.clear.onclick = () => {
          ui.log.innerHTML = "";
          state.messages = [];
        };
        ui.reset.onclick = () => resetSession();
        ui.inspectorBtn.onclick = () => {
          ui.inspector.style.display =
            ui.inspector.style.display === "none" ? "block" : "none";
        };

        ui.exportBtn.onclick = () => {
          const lines = [];
          for (const m of state.messages) {
            lines.push(`[${m.role.toUpperCase()}] ${m.content}`);
            lines.push("");
          }
          const blob = new Blob([lines.join("\n")], { type: "text/plain" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `keilani-chat-${state.sid}.txt`;
          a.click();
          URL.revokeObjectURL(a.href);
        };

        // ---------- Chat send ----------
        async function sendMessage() {
          const text = ui.prompt.value.trim();
          if (!text) return;
          ui.prompt.value = "";

          // render user bubble
          bubble("you", textNode(text));

          // keep history
          state.messages.push({ role: "user", content: text });

          // build payload (messages[] required by proxy)
          const body = {
            model: cfg.model,
            messages: state.messages.map((m) => ({
              role: m.role,
              content: m.content,
            })),
            stream: cfg.stream,
            // do NOT send temperature for gpt-5 (server enforces default)
          };

          // auth header (client token optional)
          const headers = { "Content-Type": "application/json" };
          if (cfg.token) headers["Authorization"] = `Bearer ${cfg.token}`;

          // fire
          state.t0 = Date.now();
          state.tokenCount = 0;
          updateHud();
          const useSSE = cfg.stream && cfg.sse;

          ui.inspector.textContent = `→ POST ${cfg.api}\n${JSON.stringify(body, null, 2)}`;

          try {
            const res = await fetch(cfg.api, {
              method: "POST",
              headers,
              body: JSON.stringify(body),
            });

            // Decide mode by content-type & flag
            const ct = res.headers.get("content-type") || "";
            if (useSSE && ct.includes("text/event-stream")) {
              await handleSSE(res);
            } else {
              await handleJSON(res);
            }
          } catch (err) {
            const n = errNode(`[Network] ${err.message || err}`);
            bubble("bot", n, "error");
          }
        }

        async function handleJSON(res) {
          if (!res.ok) {
            const txt = await safeText(res);
            bubble(
              "bot",
              errNode(`[Error] HTTP ${res.status}\n${txt}`),
              "error",
            );
            return;
          }
          const data = await res.json().catch(() => ({}));
          ui.inspector.textContent += `\n\n← JSON ${res.status}\n${JSON.stringify(data, null, 2)}`;

          const reply =
            data?.message ||
            data?.content ||
            data?.choices?.[0]?.message?.content ||
            "(empty)";
          const node = md(reply);
          bubble("bot", node);
          state.messages.push({
            role: "assistant",
            content: node.textContent || reply,
          });
        }

        async function handleSSE(res) {
          const reader = res.body.getReader();
          let buf = "";
          let acc = "";
          let botBubble = null;

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buf += new TextDecoder().decode(value);

            // parse SSE lines
            const parts = buf.split(/\r?\n\r?\n/g);
            buf = parts.pop(); // keep incomplete
            for (const chunk of parts) {
              const line = chunk
                .split(/\r?\n/g)
                .find((l) => l.startsWith("data:"));
              if (!line) continue;
              const payload = line.slice(5).trim();
              if (payload === "[DONE]") continue;

              try {
                const j = JSON.parse(payload);
                ui.inspector.textContent = `SSE chunk:\n${payload}`;

                const delta =
                  j.delta || j.choices?.[0]?.delta?.content || j.content || "";
                if (delta) {
                  acc += delta;
                  if (!botBubble) {
                    botBubble = bubble("bot", md(acc));
                  } else {
                    // update bubble
                    botBubble.firstChild.replaceWith(md(acc));
                  }
                }

                if (j.tokens) {
                  state.tokenCount = j.tokens;
                  updateHud();
                }
              } catch {
                /* ignore non-JSON lines */
              }
            }
          }

          // finalize
          if (acc) {
            state.messages.push({ role: "assistant", content: acc });
          }
        }

        async function safeText(res) {
          try {
            return await res.text();
          } catch {
            return "(no body)";
          }
        }

        // ---------- Hook up ----------
        ui.send.addEventListener("click", (e) => {
          e.preventDefault();
          sendMessage();
        });
        ui.prompt.focus();
        restore();
        persist();

        // Initial hello? (optional)
        // bubble('bot', textNode('Ready when you are.'));

        // global hljs line numbers or theme is already loaded by CSS file
        try {
          hljs.configure({ ignoreUnescapedHTML: true });
        } catch {}
      })();
    </script>
  </body>
</html>
