<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Keilani Brain — Live</title>
    <meta name="theme-color" content="#0b0e12" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.webmanifest" />
    <style>
      :root {
        color-scheme: dark light;
      }
      body {
        margin: 0;
        background: #0b0e12;
        color: #e6e6e6;
        font:
          16px/1.4 system-ui,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial;
      }
      .wrap {
        max-width: 1100px;
        margin: 40px auto;
        padding: 0 16px;
      }
      h1 {
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .card {
        background: #12161c;
        border: 1px solid #232a35;
        border-radius: 14px;
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      textarea {
        width: 100%;
        min-height: 160px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid #273142;
        background: #0f1319;
        color: inherit;
        padding: 12px;
        font: inherit;
      }
      select,
      button,
      input[type="range"] {
        border-radius: 10px;
        border: 1px solid #273142;
        background: #0f1319;
        color: inherit;
        font: inherit;
        padding: 10px 12px;
      }
      button.primary {
        background: #1260ff;
        border-color: #1260ff;
      }
      button:disabled,
      .btn-busy {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid #273142;
        background: #0f1319;
        font-size: 12px;
        opacity: 0.9;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .muted {
        opacity: 0.7;
      }
      .split {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      @media (min-width: 980px) {
        .split {
          grid-template-columns: 1fr 1fr;
        }
      }
      .reply {
        min-height: 140px;
        white-space: pre-wrap;
        background: #0f1319;
        border: 1px solid #273142;
        border-radius: 10px;
        padding: 12px;
      }
      .row audio {
        width: 100%;
      }

      /* UX polish */
      .meter {
        height: 6px;
        width: 160px;
        border-radius: 999px;
        background: #151a22;
        border: 1px solid #273142;
        overflow: hidden;
      }
      .meter > i {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #19c37d, #1260ff);
        transition: width 0.08s linear;
      }
      .state-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: 6px;
        background: #394b63;
        vertical-align: middle;
      }
      .state-dot.hot {
        background: #19c37d;
      }
      .meter {
        position: relative;
        width: 180px;
        height: 8px;
        background: #0f1319;
        border: 1px solid #273142;
        border-radius: 999px;
        overflow: hidden;
      }
      .meter #micBar {
        height: 100%;
        width: 0%;
        background: #22c55e;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>
        Keilani Brain — Live <span id="statePill" class="pill muted">idle</span>
      </h1>

      <div class="card">
        <div class="split">
          <div>
            <label class="muted">Message to Keilani</label>
            <textarea id="textIn" placeholder="Say hi…"></textarea>

            <div class="row" style="margin-top: 10px">
              <label for="voicePick" class="muted">Voice</label>
              <select id="voicePick">
                <option value="">(default / no TTS)</option>
              </select>

              <button id="sendBtn" class="primary">Send</button>
              <button id="chatToggleBtn" class="btn">Start chat</button>
              <!-- Mic meter + VAD threshold -->
              <div
                class="row"
                style="gap: 8px; align-items: center; margin-top: 8px"
              >
                <div class="meter">
                  <div id="micBar"></div>
                </div>
                <span id="micDb" class="mono muted">– dB</span>

                <label class="muted" style="margin-left: 8px">VAD</label>
                <input
                  id="vadThresh"
                  type="range"
                  min="1"
                  max="12"
                  value="4"
                  step="1"
                />
              </div>

              <button id="stopBtn">Stop</button>

              <span id="stateDot" class="state-dot" aria-hidden="true"></span>
              <div class="meter" title="input level"><i id="micMeter"></i></div>
            </div>
          </div>

          <div>
            <label class="muted">Last transcript</label>
            <div id="transcriptBox" class="reply mono muted">(no speech)</div>

            <div class="row" style="margin-top: 10px">
              <audio id="ttsPlayer" preload="none" controls></audio>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px">
          <label class="muted">Reply</label>
          <div id="reply" class="reply"></div>
        </div>
      </div>
    </div>

    <!-- scripts must be external to satisfy CSP 'script-src self' -->
    <script defer src="/assets/pwa.js"></script>
    <script defer src="/assets/chat.js"></script>
  </body>
</html>
